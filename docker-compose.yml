version: '3'

services:
  api:
    restart: always
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: mern_api
    volumes:
      # don't overwrite this folder in container with the local one
      - "/app/node_modules"
      # map current local directory to the /app inside the container
      #This is a must for development in order to update our container whenever a change to the source code is made. Without this, you would have to rebuild the image each time you make a change to source code.
      - ./server:/app
    ports:
      - 5000:5000

    environment:
      AUTH_DOMAIN: $${AUTH_DOMAIN}
      PROJECT_ID: $${PROJECT_ID}
      STORAGE_BUCKET: $${STORAGE_BUCKET}
      MESSAGING_SENDER_ID: $${MESSAGING_SENDER_ID}
      APP_ID: $${APP_ID}
      MEASUREMENT_ID: $${MEASUREMENT_ID}
      NODEMAILER_USER: $${NODEMAILER_USER}
      NODEMAILER_PASS: $${NODEMAILER_PASS}
      MAILING_PROJECT_ID: $${MAILING_PROJECT_ID}
      MAILING_SENDER_EMAIL_ADDRESS: $${MAILING_SENDER_EMAIL_ADDRESS}
      MAILING_SERVICE_CLIENT_ID: $${MAILING_SERVICE_CLIENT_ID}
      MAILING_SERVICE_CLIENT_SECRET: $${MAILING_SERVICE_CLIENT_SECRET}
      MAILING_SERVICE_REFRESH_TOKEN: $${MAILING_SERVICE_REFRESH_TOKEN}
      MAILING_SERVICE_ACCESS_TOKEN: $${MAILING_SERVICE_ACCESS_TOKEN}
      MAILING_REDIRECT_URI: $${MAILING_REDIRECT_URI}
    networks:
      - mern-api
  client:
    restart: always
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: mern_frontend
    environment:
      REACT_APP_API_URL: $${REACT_APP_API_URL}
    volumes:
      - "/app/node_modules"
      - ./client:/app
    ports:
      - 3000:3000
    depends_on:
      - api
    networks:
      - mern-api
  nginx:
    restart: always
    depends_on:
      - api
      - client
    build:
      context: ./nginx
      dockerfile: Dockerfile
    ports:
      - 3050:80
    networks:
      - mern-api

networks:
  mern-api:
    driver: bridge

volumes:
  mongodb-data:
    driver: local


  